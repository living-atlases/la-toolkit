services:
  la-toolkit:
    image: livingatlases/la-toolkit:dev
    container_name: la-toolkit
    restart: always
    hostname: la-toolkit
    build:
      context: .
      dockerfile: docker/u20/Dockerfile
    ports:
      - "20010:2010"
      - "20011-20100:20011-20100"
      # Internal an external ports should match in the previous range. 
      # So don't do these kind of redirections:
      # - "3011-3100:2011-2100"
    depends_on:
      mongo:
        condition: service_healthy
    environment:
      # https://en.wikipedia.org/wiki/List_of_tz_database_time_zones
      # Useful for having logs with local time
      TZ: "Europe/Copenhagen"
      # db user/pass (should match the same mongo vars LA_USER/LA_PASS)
      DATABASE_URL: mongodb://la_toolkit_user:la_toolkit_changeme@mongo:27017/la_toolkit
      # Advanced optional URLs (useful to enable https and use a proxy)
      # TOOLKIT_SENTRY_DSN: "SOME_DSN"
      # TOOLKIT_PUBLIC_URL: "localhost:2010" or "toolkit.example.com"
      TOOLKIT_PUBLIC_URL: "localhost:20010"
      # TOOLKIT_HTTPS: "false"
      # TOOLKIT_TERM_PROXY: "false"

      # The volumes should be writeable by your user so maybe you have to set your uid:gid here
      # user: "1000:1000"
      # or if you are using docker desktop and GNU/Linux via:
      # https://docs.docker.com/desktop/faqs/linuxfaqs/#how-do-i-enable-file-sharing
    volumes:
      # mkdir -p /data/la-toolkit/config/ /data/la-toolkit/logs/ /data/la-toolkit/ssh/
      - /data/la-toolkit/config/:/home/ubuntu/ansible/la-inventories/:rw
      - /data/la-toolkit/logs/:/home/ubuntu/ansible/logs/:rw
      - /data/la-toolkit/ssh:/home/ubuntu/.ssh/:rw
      - /home/ubuntu/.npm-packages
      - ./build/web:/home/ubuntu/la-toolkit/assets/:rw
      # For 'custom' ala-install
      # Take into account that if your change from 'custom' to other ala-install version
      # code changes will be git stashed
      - /data/la-toolkit/ala-install:/home/ubuntu/ansible/ala-install/:rw

  mongo:
    # Early versions used mongo:4. If you were using it, you'll need:
    # - Back up first (see mongo-db-backup) and upgrade progressively 4 -> 5 -> 6 -> 7 -> 8.
    # - Or back up, start with an empty mongo:8 instance and restore your la-toolkit DB backup.
    image: mongo:8.0.17
    restart: always
    container_name: la-toolkit-mongo
    # Uncomment if mongo-express is not enough
    ports:
      - 27017:27017
    environment:
      MONGO_INITDB_ROOT_USERNAME: la_toolkit_mongo_admin
      MONGO_INITDB_ROOT_PASSWORD: la_toolkit_changeme
      MONGO_INITDB_DATABASE: la_toolkit
      LA_USER: la_toolkit_user
      LA_PASS: la_toolkit_changeme
    volumes:
      - ./mongo-init.sh:/docker-entrypoint-initdb.d/mongo-init.sh
      - /data/la-toolkit/mongo:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')", "-u", "la_toolkit_mongo_admin", "-p", "la_toolkit_changeme", "--authenticationDatabase", "admin", "--quiet"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  mongo-db-backup:
    image: tiredofit/db-backup:latest
    container_name: la-toolkit-mongo-db-backup
    restart: always
    depends_on:
      mongo:
        condition: service_healthy
    environment:
      - DB_TYPE=mongodb
      - DB_HOST=mongo
      - DB_USER=la_toolkit_mongo_admin
      - DB_PASS=la_toolkit_changeme
      - DB_AUTH=admin
      - DB_NAME=la_toolkit
      - CONTAINER_ENABLE_MONITORING=FALSE
      - DEFAULT_BACKUP_INTERVAL=1440
      - DEFAULT_CLEAN_UP_TIME=8640
      - DEFAULT_CHECKSUM=TRUE
      - DEFAULT_CHECKSUM_TYPE=MD5
      - TZ=Europe/Copenhagen
    volumes:
      - /data/la-toolkit/backups:/backup

  #  Optionally in production (because this will open your db to the outside):
  #
  mongo-express:
    image: mongo-express
    container_name: la-toolkit-mongo-express
    restart: always
    depends_on:
      mongo:
        condition: service_healthy
    ports:
      - 9081:8081
    environment:
      - ME_CONFIG_MONGODB_SERVER=mongo
      - ME_CONFIG_MONGODB_ENABLE_ADMIN=true
      - ME_CONFIG_MONGODB_AUTHZ_DATABASE=admin
      - ME_CONFIG_MONGODB_ADMINUSERNAME=la_toolkit_mongo_admin
      - ME_CONFIG_MONGODB_ADMINPASSWORD=la_toolkit_changeme

  # 'shepherd' upgrade automatically the la-toolkit, whenever there is a new Docker image available,
  # and restarts the container to apply the update.
  # Shepherd is an actively maintained alternative to the now-archived Watchtower.

  shepherd:
    image: mazzolino/shepherd:latest
    container_name: la-toolkit-shepherd
    restart: unless-stopped
    environment:
      - SLEEP_TIME=1h # Check for updates every hour (same as watchtower's 3600s)
      - IGNORELIST_SERVICES="" # Update all services (leave empty to update all)
      - WITH_REGISTRY_AUTH=false
      - FILTER_SERVICES=label=com.centurylinklabs.watchtower.enable=true
      - VERBOSE=false
      - RUN_ONCE_AND_EXIT=false
      - APPRISE_SIDECAR_URL="" # Optional: add notification URL if needed
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:rw
    # Additional shepherd configuration via environment variables
    # See: https://github.com/djmaze/shepherd
